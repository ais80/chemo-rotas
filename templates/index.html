<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chemo Rota â†’ EPMA Converter</title>
  <style>
    /* â”€â”€ Reset & tokens â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --nhs-blue:  #005eb8;
      --nhs-dark:  #003087;
      --nhs-light: #4096d2;
      --bg:        #f0f4f8;
      --card:      #ffffff;
      --text:      #212b36;
      --muted:     #637381;
      --border:    #d0d7de;
      --success:   #0d7c56;
      --warning:   #b54708;
      --error:     #b91c1c;
      --radius:    10px;
      --shadow:    0 4px 24px rgba(0,0,0,.10);
    }

    body {
      font-family: "Segoe UI", Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    header {
      background: var(--nhs-blue);
      color: #fff;
      padding: 0 2rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      height: 64px;
      box-shadow: 0 2px 8px rgba(0,62,116,.4);
      flex-shrink: 0;
    }
    .logo {
      background: #fff;
      color: var(--nhs-blue);
      font-weight: 900;
      font-size: 1.15rem;
      letter-spacing: .04em;
      padding: .2em .55em;
      border-radius: 4px;
    }
    header h1 {
      font-size: 1.1rem;
      font-weight: 600;
      letter-spacing: .01em;
    }

    /* â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    main {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 3rem 1.5rem 2rem;
    }

    /* â”€â”€ Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .card {
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 2.5rem 2.8rem;
      width: 100%;
      max-width: 560px;
    }
    .card.wide { max-width: 820px; }

    .card h2 {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--nhs-dark);
      margin-bottom: .4rem;
    }
    .subtitle {
      color: var(--muted);
      font-size: .9rem;
      margin-bottom: 2rem;
      line-height: 1.6;
    }

    /* â”€â”€ Drop zone â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #drop-zone {
      border: 2.5px dashed var(--border);
      border-radius: var(--radius);
      padding: 2.5rem 1.5rem;
      text-align: center;
      cursor: pointer;
      transition: border-color .2s, background .2s;
      position: relative;
    }
    #drop-zone.drag-over { border-color: var(--nhs-light); background: #eef5fc; }
    #drop-zone.has-file  { border-color: var(--nhs-blue);  background: #f0f6ff; }
    #drop-zone.busy      { pointer-events: none; opacity: .7; }
    #drop-zone input[type="file"] {
      position: absolute; inset: 0; opacity: 0;
      cursor: pointer; width: 100%; height: 100%;
    }
    .drop-icon  { font-size: 2.8rem; margin-bottom: .6rem; line-height: 1; }
    .drop-label { font-size: .95rem; font-weight: 600; color: var(--nhs-dark); }
    .drop-hint  { font-size: .82rem; color: var(--muted); margin-top: .25rem; }
    #file-name  {
      display: none; margin-top: .8rem;
      font-size: .88rem; font-weight: 600;
      color: var(--nhs-blue); word-break: break-all;
    }

    /* â”€â”€ Progress bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .progress-wrap { margin-top: 1.4rem; }
    .progress-label { font-size: .85rem; color: var(--muted); margin-bottom: .5rem; }
    .progress-bar-bg {
      height: 8px; border-radius: 99px;
      background: var(--border); overflow: hidden;
    }
    .progress-bar-fill {
      height: 100%; border-radius: 99px;
      background: var(--nhs-light); width: 0%;
      transition: width .3s ease;
      animation: pulse-bar 1.6s infinite;
    }
    @keyframes pulse-bar { 0%,100%{opacity:1} 50%{opacity:.6} }

    /* â”€â”€ Status boxes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .status-box {
      border-radius: 8px; padding: .9rem 1.1rem;
      font-size: .9rem; line-height: 1.5; margin-top: 1.2rem;
    }
    .status-box.success { background:#ecfdf5; border:1.5px solid #6ee7b7; color:var(--success); }
    .status-box.warning { background:#fffbeb; border:1.5px solid #fcd34d; color:var(--warning); }
    .status-box.error   { background:#fef2f2; border:1.5px solid #fca5a5; color:var(--error); }
    .status-box ul { margin: .5rem 0 0 1.2rem; }
    .status-box li { margin-bottom: .3rem; }
    .status-box code { font-size: .85em; background: rgba(0,0,0,.06); padding: .1em .3em; border-radius: 3px; }

    /* â”€â”€ Review header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .review-header {
      display: flex; align-items: baseline;
      justify-content: space-between; gap: 1rem;
      flex-wrap: wrap; margin-bottom: 1.1rem;
    }
    .review-header h2 { margin-bottom: 0; }
    #back-btn {
      background: none; border: 1.5px solid var(--border);
      border-radius: 6px; padding: .35rem .9rem;
      font-size: .85rem; color: var(--muted); cursor: pointer;
      transition: border-color .15s, color .15s; flex-shrink: 0;
    }
    #back-btn:hover { border-color: var(--nhs-blue); color: var(--nhs-blue); }

    /* â”€â”€ Summary pills â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .summary-bar {
      display: flex; flex-wrap: wrap; gap: .4rem; margin-bottom: 1.1rem;
    }
    .pill {
      background: #f1f5f9; border: 1px solid var(--border);
      border-radius: 99px; padding: .22em .8em;
      font-size: .78rem; color: var(--text);
    }
    .pill strong { color: var(--nhs-dark); }

    /* â”€â”€ Form sections â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    fieldset {
      border: 1px solid var(--border); border-radius: 8px;
      padding: 1.1rem 1.4rem 1.3rem; margin-bottom: 1.2rem;
    }
    fieldset.required-fieldset {
      border-color: #f59e0b; background: #fffdf5;
    }
    legend {
      font-size: .88rem; font-weight: 700; color: var(--nhs-dark);
      padding: 0 .4rem; display: flex; align-items: center; gap: .5rem;
    }

    /* â”€â”€ Badges â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .badge {
      font-size: .7rem; font-weight: 700; letter-spacing: .03em;
      padding: .15em .55em; border-radius: 4px;
    }
    .badge-req  { background: #fef3c7; color: #92400e; }
    .badge-info { background: #dbeafe; color: #1e40af; }
    .badge-warn { background: #fff7ed; color: #9a3412; }

    /* â”€â”€ Field grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .field-grid {
      display: grid; grid-template-columns: 1fr 1fr;
      gap: .85rem 1.3rem; margin-top: .9rem;
    }
    @media (max-width: 560px) { .field-grid { grid-template-columns: 1fr; } }

    .field-group { display: flex; flex-direction: column; gap: .3rem; }
    .field-group.full { grid-column: 1 / -1; }

    .field-group label {
      font-size: .82rem; font-weight: 600; color: var(--text);
    }
    .field-group input,
    .field-group select,
    .field-group textarea {
      width: 100%; padding: .5rem .7rem;
      border: 1.5px solid var(--border); border-radius: 6px;
      font-size: .9rem; font-family: inherit; color: var(--text);
      background: #fff; transition: border-color .15s, box-shadow .15s;
    }
    .field-group input:focus,
    .field-group select:focus,
    .field-group textarea:focus {
      outline: none; border-color: var(--nhs-blue);
      box-shadow: 0 0 0 3px rgba(0,94,184,.12);
    }
    .field-group input.needs-input {
      border-color: #f59e0b; background: #fffbf0;
    }
    .field-group input.invalid {
      border-color: var(--error); background: #fff5f5;
    }
    .field-hint {
      font-size: .75rem; color: var(--muted); line-height: 1.3;
    }

    /* â”€â”€ Data tables â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .data-table {
      width: 100%; border-collapse: collapse;
      font-size: .8rem; margin-top: .6rem;
    }
    .data-table th {
      text-align: left; padding: .4rem .65rem;
      background: #f8fafc; font-weight: 600;
      border-bottom: 2px solid var(--border);
      color: var(--nhs-dark); white-space: nowrap;
    }
    .data-table td {
      padding: .4rem .65rem; border-bottom: 1px solid #f0f0f0;
      vertical-align: top;
    }
    .data-table tr:last-child td { border-bottom: none; }
    .data-table tr.dose-unknown td { background: #fff8f0; }
    .data-table .wrap { white-space: normal; }
    .muted { font-size: .85rem; color: var(--muted); }

    /* â”€â”€ Generate bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .generate-bar { padding-top: 1rem; }
    #generate-btn {
      display: block; width: 100%; padding: .95rem 1.5rem;
      background: var(--nhs-blue); color: #fff;
      font-size: 1.05rem; font-weight: 700; letter-spacing: .03em;
      border: none; border-radius: var(--radius);
      cursor: pointer; transition: background .2s, transform .1s;
    }
    #generate-btn:hover:not(:disabled) { background: var(--nhs-dark); }
    #generate-btn:active:not(:disabled) { transform: scale(.98); }
    #generate-btn:disabled { opacity: .55; cursor: not-allowed; }

    /* â”€â”€ Footer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    footer {
      text-align: center; padding: 1.2rem;
      font-size: .78rem; color: var(--muted);
    }
  </style>
</head>
<body>

<header>
  <span class="logo">NHS</span>
  <h1>Chemo Rota &rarr; EPMA Converter</h1>
</header>

<main>

  <!-- â•â• Step 1: Upload â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="card-upload" class="card">
    <h2>Convert a Chemo Rota PDF</h2>
    <p class="subtitle">
      Drop your chemo rota PDF below â€” data is extracted automatically and shown
      for review before generating the DOCX template and TXT upload file.<br><br>
      <strong>Review all outputs before uploading to PICS.</strong>
    </p>

    <div id="drop-zone" role="button" aria-label="Upload PDF">
      <input type="file" id="pdf-input" accept=".pdf" />
      <div class="drop-icon">ðŸ“„</div>
      <div class="drop-label">Drag &amp; drop your PDF here</div>
      <div class="drop-hint">or click to browse</div>
      <div id="file-name"></div>
    </div>

    <div class="progress-wrap" id="ext-progress" hidden>
      <p class="progress-label">Extracting data from PDF â€” this may take up to 30 seconds&hellip;</p>
      <div class="progress-bar-bg">
        <div class="progress-bar-fill" id="ext-fill"></div>
      </div>
    </div>

    <div class="status-box error" id="upload-error" hidden></div>
  </div>

  <!-- â•â• Step 2: Review â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="card-review" class="card wide" hidden>

    <div class="review-header">
      <h2>Review Extracted Data</h2>
      <button type="button" id="back-btn">&#8592; Start again</button>
    </div>

    <div id="summary-bar" class="summary-bar"></div>

    <div class="status-box warning" id="review-warnings" hidden></div>

    <form id="review-form" novalidate>

      <!-- Required fields -->
      <fieldset class="required-fieldset">
        <legend>
          Required fields
          <span class="badge badge-req">Must fill in</span>
        </legend>
        <div class="field-grid">
          <div class="field-group" id="fg-drug_prefix">
            <label for="f-drug_prefix">Drug prefix code</label>
            <input type="text" id="f-drug_prefix" autocomplete="off"
                   placeholder="e.g. DARO" maxlength="10" />
            <div class="field-hint">Short uppercase code, 3&ndash;5 letters</div>
          </div>
          <div class="field-group" id="fg-ticket_number">
            <label for="f-ticket_number">PICS ticket number</label>
            <input type="text" id="f-ticket_number" autocomplete="off"
                   placeholder="e.g. 10350" maxlength="20" />
            <div class="field-hint">Change request ticket number</div>
          </div>
          <div class="field-group" id="fg-specialty_class">
            <label for="f-specialty_class">Specialty / rota class</label>
            <input type="text" id="f-specialty_class" autocomplete="off"
                   placeholder="e.g. HAEMATOLOGY" maxlength="40" />
            <div class="field-hint">PICS rota class, uppercase</div>
          </div>
        </div>
      </fieldset>

      <!-- Extracted rota details -->
      <fieldset>
        <legend>
          Extracted rota details
          <span class="badge badge-info">Verify</span>
        </legend>
        <div class="field-grid">
          <div class="field-group">
            <label for="f-document_code">Document code</label>
            <input type="text" id="f-document_code" autocomplete="off" />
          </div>
          <div class="field-group">
            <label for="f-drug_full_name">Drug / regimen name</label>
            <input type="text" id="f-drug_full_name" autocomplete="off" />
          </div>
          <div class="field-group">
            <label for="f-cycle_delay">Cycle delay</label>
            <input type="text" id="f-cycle_delay" autocomplete="off"
                   placeholder="e.g. 3w" maxlength="10" />
            <div class="field-hint">Weeks between cycles, e.g. <code>3w</code></div>
          </div>
          <div class="field-group">
            <label for="f-default_cycles">Default cycles</label>
            <input type="number" id="f-default_cycles" min="1" max="999" />
            <div class="field-hint">Number of treatment cycles</div>
          </div>
          <div class="field-group">
            <label for="f-directorate">Directorate</label>
            <input type="text" id="f-directorate" autocomplete="off"
                   placeholder="e.g. ONC" maxlength="10" />
            <div class="field-hint">3-letter directorate code</div>
          </div>
        </div>
      </fieldset>

      <!-- Drug templates -->
      <fieldset>
        <legend>
          Drug templates
          <span class="badge badge-info" id="badge-templates">0 templates</span>
        </legend>
        <div id="templates-wrap"><p class="muted">No templates extracted.</p></div>
      </fieldset>

      <!-- Blood tests -->
      <fieldset>
        <legend>
          Blood test thresholds
          <span class="badge badge-info" id="badge-bloodtests">0 tests</span>
        </legend>
        <div id="bloodtests-wrap"><p class="muted">No blood tests extracted.</p></div>
      </fieldset>

      <!-- Rota information text -->
      <fieldset>
        <legend>
          Rota information text
          <span class="badge badge-warn">Clean up OCR artefacts if needed</span>
        </legend>
        <div class="field-group full" style="margin-top:.7rem">
          <textarea id="f-rota_info" rows="7"
                    placeholder="(none extracted â€” paste from PDF if required)"></textarea>
          <div class="field-hint">
            Separate paragraphs with a blank line. Remove any OCR noise before generating.
          </div>
        </div>
      </fieldset>

    </form>

    <div class="generate-bar">
      <button type="button" id="generate-btn">Generate &amp; Download</button>
    </div>

    <div class="progress-wrap" id="gen-progress" hidden>
      <p class="progress-label">Generating DOCX + TXT files&hellip;</p>
      <div class="progress-bar-bg">
        <div class="progress-bar-fill" id="gen-fill"></div>
      </div>
    </div>

    <div class="status-box success" id="generate-success" hidden>
      &#10003; <strong>Files generated!</strong> Your ZIP download should start automatically.
      Always check the output files against the original PDF before uploading to PICS.
    </div>
    <div class="status-box error" id="generate-error" hidden></div>

  </div><!-- /card-review -->

</main>

<footer>
  For internal use only &mdash; UHB Pharmacy / Oncology &nbsp;|&nbsp;
  Review all outputs before uploading to PICS.
</footer>

<script>
'use strict';

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _config = null;
let _progTimer = null;

// â”€â”€ Shortcuts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const $ = id => document.getElementById(id);

function showEl(id) {
  const el = typeof id === 'string' ? $(id) : id;
  el.hidden = false;
}
function hideEl(id) {
  const el = typeof id === 'string' ? $(id) : id;
  el.hidden = true;
}

function esc(s) {
  return String(s == null ? '' : s)
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// â”€â”€ Progress bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startBar(fillId) {
  clearInterval(_progTimer);
  const fill = $(fillId);
  fill.style.width = '0%';
  let pct = 0;
  _progTimer = setInterval(() => {
    pct += (90 - pct) * 0.04;
    fill.style.width = pct + '%';
  }, 200);
}
function stopBar(fillId) {
  clearInterval(_progTimer);
  const fill = $(fillId);
  fill.style.width = '100%';
  setTimeout(() => { fill.style.width = '0%'; }, 500);
}

// â”€â”€ Drop zone â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const dropZone  = $('drop-zone');
const fileInput = $('pdf-input');

dropZone.addEventListener('dragover',  e => { e.preventDefault(); dropZone.classList.add('drag-over'); });
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
dropZone.addEventListener('drop', e => {
  e.preventDefault();
  dropZone.classList.remove('drag-over');
  const f = e.dataTransfer.files[0];
  if (f) processFile(f);
});
fileInput.addEventListener('change', () => {
  if (fileInput.files[0]) processFile(fileInput.files[0]);
});

function processFile(file) {
  if (!file.name.toLowerCase().endsWith('.pdf')) {
    showErr('upload-error', 'Only PDF files are accepted.');
    return;
  }
  hideEl('upload-error');
  $('file-name').textContent = '\uD83D\uDCCE ' + file.name;
  $('file-name').style.display = 'block';
  dropZone.classList.add('has-file', 'busy');
  startExtraction(file);
}

// â”€â”€ Step 1: Extract â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function startExtraction(file) {
  showEl('ext-progress');
  startBar('ext-fill');

  const fd = new FormData();
  fd.append('pdf', file);

  try {
    const resp = await fetch('/extract', { method: 'POST', body: fd });
    const data = await resp.json();
    if (!resp.ok) throw new Error(data.error || 'Extraction failed');
    stopBar('ext-fill');
    hideEl('ext-progress');
    _config = data.config;
    showReview(data.config, data.warnings || []);
  } catch (err) {
    stopBar('ext-fill');
    hideEl('ext-progress');
    dropZone.classList.remove('busy');
    showErr('upload-error', err.message);
  }
}

// â”€â”€ Step 2: Populate review â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showReview(cfg, warnings) {
  hideEl('card-upload');
  showEl('card-review');

  // Summary pills
  const pills = [
    cfg.drug_full_name  && `<span class="pill"><strong>Drug:</strong> ${esc(cfg.drug_full_name)}</span>`,
    cfg.document_code   && `<span class="pill"><strong>Doc code:</strong> ${esc(cfg.document_code)}</span>`,
    cfg.cycle_delay     && `<span class="pill"><strong>Cycle:</strong> ${esc(cfg.cycle_delay)}</span>`,
    `<span class="pill"><strong>Templates:</strong> ${(cfg.templates||[]).length}</span>`,
    `<span class="pill"><strong>Blood tests:</strong> ${(cfg.blood_tests||[]).length}</span>`,
  ].filter(Boolean);
  $('summary-bar').innerHTML = pills.join('');

  // Warnings
  if (warnings.length) {
    $('review-warnings').innerHTML =
      '<strong>&#9888; These fields need manual input:</strong>' +
      '<ul>' + warnings.map(w => `<li>${w}</li>`).join('') + '</ul>';
    showEl('review-warnings');
  } else {
    hideEl('review-warnings');
  }

  // Required fields
  setField('drug_prefix',    cfg.drug_prefix);
  setField('ticket_number',  cfg.ticket_number);
  setField('specialty_class',cfg.specialty_class);

  // Other fields
  setField('document_code',  cfg.document_code,  false);
  setField('drug_full_name', cfg.drug_full_name,  false);
  setField('cycle_delay',    cfg.cycle_delay,     false);
  setField('directorate',    cfg.directorate,     false);
  if (cfg.default_cycles) $('f-default_cycles').value = cfg.default_cycles;

  // Rota info
  $('f-rota_info').value = (cfg.rota_info_paragraphs || []).join('\n\n');

  // Tables
  renderTemplates(cfg.templates || []);
  renderBloodTests(cfg.blood_tests || []);

  // Clear stale generate messages
  hideEl('generate-success');
  hideEl('generate-error');
  hideEl('gen-progress');
  $('generate-btn').disabled = false;

  // Auto-focus first empty required field
  for (const id of ['f-drug_prefix','f-ticket_number','f-specialty_class']) {
    if (!$(id).value) { $(id).focus(); break; }
  }

  // Scroll to top
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function setField(name, value, highlightIfMissing = true) {
  const el = $('f-' + name);
  if (!el) return;
  const empty = !value || value === 'CHANGE_ME';
  el.value = empty ? '' : value;
  if (highlightIfMissing) el.classList.toggle('needs-input', empty);
}

// â”€â”€ Templates table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTemplates(templates) {
  const badge = $('badge-templates');
  badge.textContent = templates.length + ' template' + (templates.length !== 1 ? 's' : '');

  if (!templates.length) {
    $('templates-wrap').innerHTML = '<p class="muted">No templates extracted &mdash; check original PDF.</p>';
    return;
  }

  const rows = templates.map(t => {
    const hasDose = t.dose > 0;
    const doseCell = hasDose
      ? esc(t.dose) + esc(t.units || '')
      : '<span style="color:#b54708;font-weight:600">&#9888; UNKNOWN</span>';
    const tc = t.timing_constraints
      ? `<span title="${esc(t.timing_constraints)}" style="cursor:help">&#8505;</span> `
      : '';
    return `<tr${hasDose ? '' : ' class="dose-unknown"'}>
      <td><strong>${esc(t.drug_name_upper||'')}</strong></td>
      <td>${doseCell}</td>
      <td>${esc(t.frequency||'')}</td>
      <td>${esc(t.route||'')}</td>
      <td>${esc(t.mode||'')}</td>
      <td>${esc(t.first_dose_day||'')}</td>
      <td>${esc(t.final_dose_day||'')}</td>
      <td>${esc(t.group||'')}</td>
      <td>${tc}${esc(t.timing_constraints||'')}</td>
    </tr>`;
  }).join('');

  $('templates-wrap').innerHTML = `
    <div style="overflow-x:auto">
    <table class="data-table">
      <thead><tr>
        <th>Drug</th><th>Dose</th><th>Freq</th><th>Route</th>
        <th>Mode</th><th>Day from</th><th>Day to</th><th>Group</th><th>Timing notes</th>
      </tr></thead>
      <tbody>${rows}</tbody>
    </table>
    </div>`;
}

// â”€â”€ Blood tests table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderBloodTests(tests) {
  const badge = $('badge-bloodtests');
  badge.textContent = tests.length + ' test' + (tests.length !== 1 ? 's' : '');

  if (!tests.length) {
    $('bloodtests-wrap').innerHTML = '<p class="muted">No blood tests extracted &mdash; check original PDF.</p>';
    return;
  }

  const rows = tests.map(t => `<tr>
    <td><strong>${esc(t.test_code||'')}</strong></td>
    <td>${esc(t.threshold_function||'')} ${esc(t.threshold_value||'')}</td>
    <td class="wrap">${esc(t.message_text_line1||'')}</td>
    <td class="wrap">${esc(t.message_text_line3||'')}</td>
  </tr>`).join('');

  $('bloodtests-wrap').innerHTML = `
    <div style="overflow-x:auto">
    <table class="data-table">
      <thead><tr>
        <th>Test</th><th>Condition</th><th>Message (line 1)</th><th>Action text (line 3)</th>
      </tr></thead>
      <tbody>${rows}</tbody>
    </table>
    </div>`;
}

// â”€â”€ Generate â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$('generate-btn').addEventListener('click', generateDownload);

async function generateDownload() {
  hideEl('generate-error');
  hideEl('generate-success');

  // Validate required fields
  const required = ['drug_prefix','ticket_number','specialty_class'];
  const missing = required.filter(n => !$('f-' + n).value.trim());
  if (missing.length) {
    missing.forEach(n => $('f-' + n).classList.add('invalid'));
    showErr('generate-error', 'Please fill in all required fields (highlighted above) before generating.');
    $('f-' + missing[0]).focus();
    $('f-' + missing[0]).scrollIntoView({ behavior: 'smooth', block: 'center' });
    return;
  }
  required.forEach(n => $('f-' + n).classList.remove('invalid'));

  // Deep copy config and overlay form values
  const cfg = JSON.parse(JSON.stringify(_config));

  // Text fields
  ['drug_prefix','ticket_number','specialty_class',
   'document_code','drug_full_name','cycle_delay','directorate'].forEach(n => {
    const v = $('f-' + n).value.trim();
    if (v) cfg[n] = v;
  });

  // Auto-uppercase
  ['drug_prefix','specialty_class'].forEach(n => {
    if (cfg[n]) cfg[n] = cfg[n].toUpperCase();
  });

  // Numeric
  const cyc = $('f-default_cycles').value;
  if (cyc) cfg.default_cycles = parseInt(cyc, 10);

  // Rota info â€” split on blank lines, normalise newlines within a paragraph
  cfg.rota_info_paragraphs = $('f-rota_info').value
    .split(/\n{2,}/)
    .map(p => p.replace(/\n+/g, ' ').trim())
    .filter(Boolean);

  // Request
  $('generate-btn').disabled = true;
  showEl('gen-progress');
  startBar('gen-fill');

  try {
    const resp = await fetch('/generate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(cfg),
    });

    if (!resp.ok) {
      const d = await resp.json().catch(() => ({}));
      throw new Error(d.error || 'Generation failed');
    }

    stopBar('gen-fill');

    // Trigger download
    const blob = await resp.blob();
    const url  = URL.createObjectURL(blob);
    const a    = document.createElement('a');
    const cd   = resp.headers.get('Content-Disposition') || '';
    const m    = cd.match(/filename="?([^";\r\n]+)"?/);
    a.download  = m ? m[1] : 'converted.zip';
    a.href      = url;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);

    showEl('generate-success');
  } catch (err) {
    stopBar('gen-fill');
    showErr('generate-error', err.message);
  } finally {
    hideEl('gen-progress');
    $('generate-btn').disabled = false;
  }
}

// â”€â”€ Back button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$('back-btn').addEventListener('click', () => {
  _config = null;
  fileInput.value = '';
  $('file-name').textContent = '';
  $('file-name').style.display = 'none';
  dropZone.classList.remove('has-file','busy','drag-over');
  hideEl('ext-progress');
  hideEl('upload-error');
  hideEl('card-review');
  showEl('card-upload');
  window.scrollTo({ top: 0, behavior: 'smooth' });
});

// â”€â”€ Input cleanup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
['drug_prefix','ticket_number','specialty_class'].forEach(n => {
  $('f-' + n).addEventListener('input', () => {
    $('f-' + n).classList.remove('needs-input','invalid');
    hideEl('generate-error');
  });
});

// Auto-uppercase on blur
['f-drug_prefix','f-specialty_class'].forEach(id => {
  $(id).addEventListener('blur', () => {
    $(id).value = $(id).value.toUpperCase().trim();
  });
});

// â”€â”€ Error helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showErr(id, msg) {
  const el = $(id);
  el.textContent = '\u274C ' + msg;
  el.hidden = false;
}
</script>

</body>
</html>
